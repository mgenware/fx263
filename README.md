# mingru (WIP)

[![MEAN Module](https://img.shields.io/badge/MEAN%20Module-TypeScript-blue.svg?style=flat-square)](https://github.com/mgenware/MEAN-Module)
[![Build Status](https://img.shields.io/travis/mgenware/mingru.svg?style=flat-square&label=Build+Status)](https://travis-ci.org/mgenware/mingru)
[![npm version](https://img.shields.io/npm/v/mingru.svg?style=flat-square)](https://npmjs.com/package/mingru)
[![Node.js Version](http://img.shields.io/node/v/mingru.svg?style=flat-square)](https://nodejs.org/en/)

Convert [dd-models](https://github.com/mgenware/dd-models) to Go code.

An SQL builder for Go (golang), leveraging the power of TypeScript to define and convert database models to Go code.

Goals:

* Builds code with raw SQL, provides **low performance overhead at runtime**
* Must be **strongly typed**
* Currently focuses on Go and MySQL/MariaDB

See [FAQ](#faq) below for more details.

## Example

### Step 1: Define your models

For example, let's define a simple user table with 3 columns using [dd-models](https://github.com/mgenware/dd-models):

```ts
// ----------- user table model (user.ts) -----------
import * as dd from 'dd-models';

class User extends dd.Table {
  id = dd.pk();
  name = dd.varChar(100);
  sig = dd.text().nullable;
}

export default dd.table(User);
```

### Step 2: Define you actions

Let's import the user table (`user.ts`) above, and add some CRUD actions:

```ts
import * as dd from 'dd-models';
import user from './user';

const userTA = dd.actions(user);
// Select a user profile by ID
userTA.select('UserProfile', user.id, user.name, user.sig).byID();
// Select all user profiles
userTA.selectAll('AllUserProfiles', user.id, user.name, user.sig);
// Select the single sig field by ID
userTA.selectField('Sig', user.sig).byID();

// Update an user profile by ID
userTA
  .updateOne('UserProfile')
  .setInputs(user.name, user.sig)
  .byID();

// Delete an user by ID
userTA.deleteOne('ByID').byID();

export default userTA;
```

### Step 3: Generate the Go Code
The following is the Go code generated by mingru from the actions above (function bodies are omitted for simplicity):

```go
// SelectUserProfileResult ...
type SelectUserProfileResult struct {
	UserID   uint64
	UserName string
	UserSig  *string
}
// SelectUserProfile ...
func (da *TableTypeUser) SelectUserProfile(queryable sqlx.Queryable, userID uint64) (*SelectUserProfileResult, error)
// SelectAllUserProfilesResult ...
type SelectAllUserProfilesResult struct {
	UserID   uint64
	UserName string
	UserSig  *string
}
// SelectAllUserProfiles ...
func (da *TableTypeUser) SelectAllUserProfiles(queryable sqlx.Queryable) ([]*SelectAllUserProfilesResult, error)
// SelectSig ...
func (da *TableTypeUser) SelectSig(queryable sqlx.Queryable, userID uint64) (*string, error)
// UpdateUserProfile ...
func (da *TableTypeUser) UpdateUserProfile(queryable sqlx.Queryable, userID uint64, userName string, userSig *string) error
// DeleteByID ...
func (da *TableTypeUser) DeleteByID(queryable sqlx.Queryable, userID uint64) error
```

# Usage

## Defining Models

mingru converts [dd-models](https://github.com/mgenware/dd-models) to Go code, please refer to [dd-models docs](https://github.com/mgenware/dd-models) for details.

## Generating Go Code

Once you are familiar with [dd-models](https://github.com/mgenware/dd-models), you can import your actions, and use `mingru.build` along with a dialect to generate Go code:

```ts
function build(
  // An array of dd-models table actions
  tableActionList: dd.TableActionCollection[],
  // A dialect object, currently, only MySQL is supported
  dialect: Dialect,
  // The output directory where Go files are written to
  outDir: string,
  // Extra options
  options?: IBuildOption,
): Promise<void>;
```

Example:

```ts
// mingru.ts
import * as mr from 'mingru';
// Import your model actions
import userTA from './models/userTA';

(async () => {
  const actions = [userTA];
  const dialect = new mr.MySQL();
  // Build Go code to '../da/` directory
  await mr.build(actions, dialect, '../da/');
})();
```

It's also recommended to use `ts-node` and add build command to `package.json` scripts section:

```json
{
  "scripts": {
    "build": "ts-node mingru.ts"
  },
}
```

Now you can build your project using `yarn build`.

## More examples
For a more detailed and runnable example, visit [mingru-go-example](https://github.com/mgenware/mingru-go-example)

## FAQ

### Why rely on Node.js/TypeScript? why not use Go to generate Go code?

The problem of Go is, it cannot offer a way to declare models in a strongly typed way, for example, this is how a model typically looks like in a Go-based library:

```go
type User struct {
  lib.Model           `table:"users"`
  ID        int64     `pk:"autoincr"`
  Username  string
  Email     string
  Password  string
  CreatedAt time.Time
}
```

It uses Go struct field tags to inject model info, thus tends to be error-prone. Below is the code for defining models in mingru using TypeScript, everything is strongly typed:

```ts
import * as dd from 'dd-models';

class User extends dd.Table {
  id = dd.pk();
  name = dd.varChar(100);
  sig = dd.text().nullable;
}

export default dd.table(User);
```
